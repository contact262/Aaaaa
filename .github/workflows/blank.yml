name: VPS Ubuntu Setup (Python + RDP)

on:
  workflow_dispatch:  # Trigger manual

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 jam

    steps:
      - name: Update & Install Base Packages
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server python3 python3-pip netcat-openbsd curl

      - name: Create SSH Superuser
        # PERINGATAN: Hardcode password tidak aman, sebaiknya pakai GitHub Secrets
        run: |
          USERNAME="vps"
          PASSWORD="Igede123456@"  # sama seperti sebelumnya

          # Hapus user lama bila ada
          if id "$USERNAME" &>/dev/null; then
            sudo userdel -r "$USERNAME" || true
          fi

          # Buat user
          sudo useradd -m -s /bin/bash "$USERNAME"
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd

          # Jadikan superuser (full sudo tanpa password)
          sudo usermod -aG sudo "$USERNAME"
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/90-$USERNAME >/dev/null
          sudo chmod 440 /etc/sudoers.d/90-$USERNAME

          echo "SSH_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "SSH_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: Configure SSH Daemon
        run: |
          sudo sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication .*/PubkeyAuthentication yes/' /etc/ssh/sshd_config

          sudo systemctl enable ssh
          sudo systemctl restart ssh

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Establish Tailscale Connection
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          HOSTNAME="gh-vps-${GITHUB_RUN_ID}"

          sudo tailscale up --authkey="${TAILSCALE_AUTH_KEY}" --hostname="${HOSTNAME}" --accept-routes

          TS_IP=$(tailscale ip -4 | head -n 1)

          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "VPS_HOSTNAME=$HOSTNAME" >> $GITHUB_ENV

      - name: Install Desktop & RDP Server (xrdp + XFCE)
        run: |
          # Install desktop ringan dan xrdp
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xrdp xfce4 xfce4-goodies

          # Set sesi XFCE untuk user SSH
          SSH_USERNAME="$(grep '^SSH_USERNAME=' $GITHUB_ENV | cut -d'=' -f2)"

          sudo -u "$SSH_USERNAME" mkdir -p /home/"$SSH_USERNAME"
          echo "xfce4-session" | sudo tee /home/"$SSH_USERNAME"/.xsession >/dev/null
          sudo chown "$SSH_USERNAME:$SSH_USERNAME" /home/"$SSH_USERNAME"/.xsession

          # Pastikan xrdp pakai /bin/bash dan environment benar
          if [ -f /etc/xrdp/startwm.sh ]; then
            sudo sed -i 's/^test -x.*$//g' /etc/xrdp/startwm.sh
            sudo sed -i 's/^exec \/bin\/sh.*$//g' /etc/xrdp/startwm.sh
            echo 'startxfce4' | sudo tee /etc/xrdp/startwm.sh >/dev/null
          fi

          # Aktifkan dan restart xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp

      - name: Verify SSH Accessibility (via Tailscale)
        run: |
          echo "Tes koneksi ke port 22 VPS (via Tailscale)..."
          nc -vz "$TAILSCALE_IP" 22 || echo "Peringatan: tes netcat gagal, cek manual dari client."

      - name: Verify RDP Port (3389 via Tailscale)
        run: |
          echo "Tes koneksi ke port 3389 (RDP) VPS (via Tailscale)..."
          nc -vz "$TAILSCALE_IP" 3389 || echo "Peringatan: port 3389 belum bisa diakses, cek xrdp/log."

      - name: Display Connection Information (SSH + RDP)
        run: |
          BORDER="$(printf '=%.0s' {1..60})"
          echo ""
          echo "$BORDER"
          echo "           INFORMASI AKSES VPS UBUNTU (SUPERUSER + RDP)"
          echo "$BORDER"
          echo "  Address (IP Tailscale) : $TAILSCALE_IP"
          echo "  Hostname               : $VPS_HOSTNAME"
          echo "  Username               : $SSH_USERNAME"
          echo "  Password               : $SSH_PASSWORD"
          echo ""
          echo "  SSH:"
          echo "    ssh $SSH_USERNAME@$TAILSCALE_IP"
          echo ""
          echo "  RDP:"
          echo "    Host / Computer  : $TAILSCALE_IP:3389"
          echo "    User / Username  : $SSH_USERNAME"
          echo "    Password         : $SSH_PASSWORD"
          echo "    Desktop          : XFCE (via xrdp)"
          echo "$BORDER"
          echo "  HAK AKSES:"
          echo "  - $SSH_USERNAME punya sudo FULL tanpa password (superuser)"
          echo "  - Contoh: sudo su -"
          echo "$BORDER"
          echo "  PENTING: JANGAN TUTUP JOB GITHUB ACTIONS INI."
          echo "  Biarkan workflow tetap berjalan untuk menjaga sesi."
          echo "  Stop workflow jika sudah selesai."
          echo "$BORDER"
          echo ""

      - name: Maintain Active Connection (Keep-Alive)
        run: |
          COUNTER=0
          while true; do
            COUNTER=$((COUNTER+1))
            NOW=$(date +"%Y-%m-%d %H:%M:%S")
            echo "[$NOW] VPS Ubuntu aktif - Siklus: $COUNTER"
            echo " ↳ IP: $TAILSCALE_IP | User: $SSH_USERNAME"
            if [ $((COUNTER % 3)) -eq 0 ]; then
              echo " ↳ Memeriksa status Tailscale..."
              tailscale status || true
            fi
            if [ $((COUNTER % 6)) -eq 0 ]; then
              echo " ↳ Memeriksa status xrdp..."
              systemctl status xrdp --no-pager || true
            fi
            sleep 300
          done
