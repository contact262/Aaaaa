name: VPS Ubuntu Setup (Python + RDP)

on:
  workflow_dispatch:  # Trigger manual

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 jam

    defaults:
      run:
        shell: bash

    steps:
      - name: Update & Install Base Packages
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y openssh-server python3 python3-pip netcat-openbsd curl
          sudo systemctl enable ssh || true
          sudo systemctl restart ssh || true

      - name: Create SSH Superuser
        # PERINGATAN: Hardcode password tidak aman, sebaiknya pakai GitHub Secrets
        run: |
          set -euxo pipefail
          USERNAME="vps"
          PASSWORD="Igede123456@"  # sama seperti sebelumnya

          # Hapus user lama bila ada
          if id "$USERNAME" &>/dev/null; then
            sudo userdel -r "$USERNAME" || true
          fi

          # Buat user
          sudo useradd -m -s /bin/bash "$USERNAME"
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd

          # Jadikan superuser (full sudo tanpa password)
          sudo usermod -aG sudo "$USERNAME"
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/90-$USERNAME >/dev/null
          sudo chmod 440 /etc/sudoers.d/90-$USERNAME

          # Export ke environment step berikutnya
          echo "SSH_USERNAME=$USERNAME" >> "$GITHUB_ENV"
          echo "SSH_PASSWORD=$PASSWORD" >> "$GITHUB_ENV"

      - name: Configure SSH Daemon
        run: |
          set -euxo pipefail
          sudo sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PubkeyAuthentication .*/PubkeyAuthentication yes/' /etc/ssh/sshd_config

          sudo systemctl enable ssh || true
          sudo systemctl reload ssh || sudo systemctl restart ssh

      - name: Install Tailscale
        run: |
          set -euxo pipefail
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale version || true

      - name: Establish Tailscale Connection
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          set -euxo pipefail

          if [ -z "${TAILSCALE_AUTH_KEY:-}" ]; then
            echo "ERROR: TAILSCALE_AUTH_KEY kosong. Set di GitHub Secrets."
            exit 1
          fi

          HOSTNAME="gh-vps-${GITHUB_RUN_ID}"

          sudo tailscale up \
            --authkey="${TAILSCALE_AUTH_KEY}" \
            --hostname="${HOSTNAME}" \
            --accept-routes

          # Beri sedikit waktu agar IP ter-assign
          sleep 5

          TS_IP=$(sudo tailscale ip -4 | head -n 1 || true)

          if [ -z "$TS_IP" ]; then
            echo "ERROR: Tidak bisa mendapatkan IP Tailscale (IPv4)."
            sudo tailscale status || true
            exit 1
          fi

          echo "TAILSCALE_IP=$TS_IP" >> "$GITHUB_ENV"
          echo "VPS_HOSTNAME=$HOSTNAME" >> "$GITHUB_ENV"

      - name: Install Desktop & RDP Server (xrdp + XFCE)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xrdp xfce4 xfce4-session xfce4-goodies dbus-x11

          # Paksa sesi XFCE saat login RDP
          echo "startxfce4" | sudo tee "/home/$SSH_USERNAME/.xsession" >/dev/null
          sudo chown "$SSH_USERNAME:$SSH_USERNAME" "/home/$SSH_USERNAME/.xsession"

          # Konfigurasi startwm.sh untuk xrdp → XFCE
          sudo cp /etc/xrdp/startwm.sh /etc/xrdp/startwm.sh.bak || true
          sudo sed -i '/^test -x .*$/d' /etc/xrdp/startwm.sh
          sudo sed -i '/^exec .*$/d' /etc/xrdp/startwm.sh

          cat << 'EOF' | sudo tee /etc/xrdp/startwm.sh >/dev/null
#!/bin/sh
unset DBUS_SESSION_BUS_ADDRESS
unset XDG_RUNTIME_DIR
. /etc/X11/Xsession
startxfce4
EOF

          sudo chmod +x /etc/xrdp/startwm.sh

          # Aktifkan dan restart xrdp
          sudo systemctl enable xrdp
          sudo systemctl restart xrdp
          sudo systemctl status xrdp --no-pager || true

      - name: Verify SSH Accessibility (via Tailscale)
        run: |
          set -euxo pipefail
          echo "Tes koneksi ke port 22 VPS (via Tailscale)..."
          nc -vz "$TAILSCALE_IP" 22 || echo "Peringatan: tes netcat ke port 22 gagal, cek manual dari client."

      - name: Verify RDP Port (3389 via Tailscale)
        run: |
          set -euxo pipefail
          echo "Tes koneksi ke port 3389 (RDP) VPS (via Tailscale)..."
          nc -vz "$TAILSCALE_IP" 3389 || echo "Peringatan: port 3389 belum bisa diakses, cek layanan xrdp / firewall."

      - name: Display Connection Information (SSH + RDP)
        run: |
          set -euxo pipefail
          BORDER="$(printf '=%.0s' {1..60})"
          echo ""
          echo "$BORDER"
          echo "           INFORMASI AKSES VPS UBUNTU (SUPERUSER + RDP)"
          echo "$BORDER"
          echo "  Address (IP Tailscale) : $TAILSCALE_IP"
          echo "  Hostname               : $VPS_HOSTNAME"
          echo "  Username               : $SSH_USERNAME"
          echo "  Password               : $SSH_PASSWORD"
          echo ""
          echo "  SSH:"
          echo "    ssh $SSH_USERNAME@$TAILSCALE_IP"
          echo ""
          echo "  RDP:"
          echo "    Host / Computer  : $TAILSCALE_IP:3389"
          echo "    User / Username  : $SSH_USERNAME"
          echo "    Password         : $SSH_PASSWORD"
          echo "    Desktop          : XFCE (via xrdp)"
          echo "$BORDER"
          echo "  HAK AKSES:"
          echo "  - $SSH_USERNAME punya sudo FULL tanpa password (superuser)"
          echo "  - Contoh: sudo su -"
          echo "$BORDER"
          echo "  PENTING: JANGAN TUTUP JOB GITHUB ACTIONS INI."
          echo "  Biarkan workflow tetap berjalan untuk menjaga sesi."
          echo "  Stop workflow jika sudah selesai."
          echo "$BORDER"
          echo ""

      - name: Maintain Active Connection (Keep-Alive)
        run: |
          set -euxo pipefail
          COUNTER=0
          while true; do
            COUNTER=$((COUNTER+1))
            NOW=$(date +"%Y-%m-%d %H:%M:%S")
            echo "[$NOW] VPS Ubuntu aktif - Siklus: $COUNTER"
            echo " ↳ IP: $TAILSCALE_IP | User: $SSH_USERNAME"
            if [ $((COUNTER % 3)) -eq 0 ]; then
              echo " ↳ Memeriksa status Tailscale..."
              sudo tailscale status || true
            fi
            if [ $((COUNTER % 6)) -eq 0 ]; then
              echo " ↳ Memeriksa status xrdp..."
              sudo systemctl status xrdp --no-pager || true
            fi
            sleep 300
          done
